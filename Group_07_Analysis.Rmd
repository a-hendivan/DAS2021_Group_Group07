---
title: "Group_07_Analysis"
author: "Group 7"
output:
  pdf_document:
    latex_engine: xelatex
    number_sections: yes
  html_document:
    df_print: paged
fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE, comment = NA)
```

```{r libraries}
library(tidyverse)
library(moderndive)
library(skimr)
library(kableExtra)
library(gridExtra)
library(broom)
library(janitor)
library(ggplot2)
library(GGally)
library(sjPlot)
```


```{r data}
film <- read.csv("dataset7.csv") 
# Split output Y into 2 groups >7 and <=7  
film <- film %>% 
  mutate(Rate = ifelse(film$rating >7 , ">7" ,"<=7"))%>%
  mutate_at(vars(Rate ) , funs(factor))
# Find NA observations 
# There are 92 missing data 
```
# Introduction {#sec:Intro}

IMDb is a platform that provides information , ratings and reviews on films, movies and many other streaming content. 
Our group was given a dataset taken from this databese, which has records of 2387 films released from  `r min(film$year) ` to `r max(film$year)`.
Each film has a unique identification number (id) and some other measurments related to it. Those are : 
\begin{itemize} 
\item $ Year_i $   : the year the film was released at cinemas 
\item $ Length_i $ : duration of film in minutes 
\item $ Budget_i$  : Budget for film production in$ \$ 10^ 5$'s
\item $ Vote_i $   : Number of positive votes
\item $ Genre_i $  : Genre of film
\item $ Rating_i $ : IMDb rating from 1 to 10 
\end{itemize}




# Exploratory Data Analysis {#sec:EDA}

Taking a glance at the summaries of the variables shown in Table \ref{tab:summary} we notice that length variable has many outliers , and that is given by 
the big difference between its maximum value and its third quartile value ,that is  399 minutes and 100 minutes respectively.
Budget also has a wide range of variability and an amount of outliers . 
It is worth mentioning that votes have a large sandard deviation , 4370 to be exact and that might be because of an outlier that presents a huge difference with the rest. Possibly a small number of films had respectively huge number of votings compared to the rest of films. 

```{r summary}
my_skim <- skim_with(base = sfl(n = length))
film%>%
  select(-c(1:2,6,8)) %>% 
  my_skim() %>% 
  transmute(Variable=skim_variable, Mean=numeric.mean, SD=numeric.sd,
            Min=numeric.p0, Q1=numeric.p25, Median=numeric.p50, Q3=numeric.p75,Max=numeric.p100,
            IQR = numeric.p75-numeric.p50) %>% 
  kable(caption = '\\label{tab:summary}Summary statistics of variables in the data set.' ,
        booktabs = TRUE, linesep = "", digits = 3) %>%
  kable_styling(font_size = 10, latex_options = "hold_position")
```

```{r ratings ,out.width='58%', fig.align="center",fig.cap = "\\label{fig:ratings} Density Of Ratings", fig.pos = 'H'}
ggplot(film, aes(x=rating)) + 
   geom_histogram(col="white",fill="wheat4")+
   labs(y="Frequency")+
   scale_x_continuous(name="Rating", limits=c(0, 10),n.breaks = 10)+
   theme_light()
```

Given the barplot in Figure\ref{fig:genre} we notice that the majority of films are within one of the 3 most dominant categories 
Action, Comedy and Drama. On the opposite Animation Documentary and Short films have relatively lower frequencies. 
Finaly Romance films are comparatively very rare among our list of films ( only `r nrow(film[film$genre=="Romance",]) ` films where Romantic among all `r nrow(film) `)

```{r genre , out.width='58%', fig.align="center",fig.cap = "\\label{fig:genre} Frequency of each genre.", fig.pos = 'H'}
  
# Genre Variable #
#================#

# check variability 
ggplot(film , aes(x=genre)) + 
   geom_bar(col= "white",fill="SkyBlue3",ylim=c(0,700,50)) + 
   geom_text(aes(label=..count..),stat="count", vjust=1.2, color="white", size=3.5 )+
   labs(x="Genre" , y ="Frequency")+
   theme_light()
```




``` {r, out.width='75%', fig.align="center",fig.cap = "\\label{fig:genredist} Distribution of genre.", fig.pos = 'H'}
# Contingency Table 
con_table<- film %>% 
     tabyl(Rate, genre) %>% 
     adorn_percentages() %>% 
     adorn_pct_formatting() %>% 
     adorn_ns() %>%
   kable(caption = '\\label{tab:cont}Summary statistics of variables in the data set.' ,
         booktabs = TRUE, linesep = "") %>%
  kable_styling(font_size = 10, latex_options = "hold_position")


p1 <- ggplot ( film , aes(x= Rate, y= ..prop.., group= genre,fill=genre)) + 
   geom_bar(col ="white" , position="dodge",stat = "count") + 
   scale_fill_discrete()+
   labs(x="Rate" , y="Proportion")+
   theme_light()
 
p2<-  ggplot(film, aes(x = rating)) +
    geom_density(aes(color = genre)) +
    labs(x="Rate")+
    theme_light()

grid.arrange(p1,p2,nrow=2)
  

```
From both the density graph and the barplot, we can see that Short,Documentary,Comedy and Animation films are more likely to get rates over 7.5 compared to rates given to Romance, Drama and Action films,lower than 7 ( 5 to be exact ) 
Given the contingency Table \ref{tab:cont}we can make some important notes. First, all Romance films have ratings below 7. 
Secondly, Animation and Short movies have a very little proportion that are rated below 7, only 3.3% and  0.1% respectively. 
Lastly Drama films are most likely to be rated below 7, with only 4% being rated over 7.
These observations lead eliminating those genres since they do not provide useful information for the rating scale.

 
 
```{r budget, out.width='58%', fig.align="center",fig.cap = "\\label{fig:budget} Budget and Rate.", fig.pos = 'H'}
# Budget # 
#=========#
ggplot( film , aes( x= Rate , y= budget,fill=Rate )) + 
   geom_boxplot() +
   scale_fill_manual(values=c("coral2", "lightblue"))+
   labs(x="Rate" , y =paste("Budget (in $ 10000's )"))+
   theme_light()


```

```{r length ,  out.width='58%', fig.align="center",fig.cap = "\\label{fig:length} Rating based on length of the film.", fig.pos = 'H'}

# Length # 
#==========# 

summary(film$length) 

# There are 55 missing data 
# Comparing the 3rd Quartile and Maximum value ( 100, 399 respectively ) we see that length has many outliers

# # Check density of length 
# ggplot(film , aes(x=length)) + 
#    geom_bar(fill="lightblue")+
#    theme_light()

# Rate ~ Length 
ggplot(film , aes(x= Rate , y= length, fill = Rate)) + 
   geom_boxplot() +
   scale_fill_manual(values=c("coral3", "lightblue"))+
   labs(x="Ratings" , y ="Length (in minutes)")+
   theme_light()

```
Figure \ref{fig:length} shows that the length feature has many outliers. That is explained by the large number of points graphed outside the box. Those points represent films that have duration longer than 100 minutes which is our $3^{rd}$ quartile. We have `r nrow(na.omit(film[  film$length >100+1.5*IQR(film$length,na.rm=T) & film$Rate=="<=7",] ))` outliers.
Despite the outliers we might assume that length in fact has an effect on the rate since for each group of rate the range of length is significantly different.

```{r year ,  out.width='58%', fig.align="center",fig.cap = "\\label{fig:year} Rating based on Year Of Release of the film", fig.pos = 'H'} 
# Year # 
#=======# 
y1 <- ggplot(film , aes(x = (year) , group= Rate , fill=Rate)) + 
   scale_fill_manual(values = c("coral3" , "steelblue"))+
   labs(x="Year" , y = "Frequency")+
      geom_bar()+
   theme_light()

y2 <- ggplot( film, aes(x = Rate , y = year )) + 
  geom_boxplot(fill=c("coral3","steelblue")) + 
   labs(y="Year of Release")+
   theme_light()
grid.arrange(y1, y2 , nrow=2)

```
From the second plot in Figure\ref{fig:year}, we have the rate against the year(year of release), although it seems that people tend to rate more films in general, however the difference between giving a rate over 7 and lower than 7 for different years of release did not change dramatically.
That is also obvious in the next boxplot, where both boxes have neary the same range.


```{r votes,  out.width='58%', fig.align="center",fig.cap = "\\label{fig:votes} Rating based on Number of positive votes", fig.pos = 'H'}

# Positive Votes # 
#=================#

# Check variability of Votes variable 
v1 <-ggplot(film , aes(x=scale(votes),y=Rate))+ 
   geom_jitter(col= "lightblue",width=0.5)+
   labs(x="Votes ( scaled) " , y="Rating ( 1-10) ")+
      theme_light()

v2 <- ggplot(film , aes(y= log(votes) , x= Rate , fill=Rate )) + 
   geom_boxplot() + 
    scale_fill_manual(values=c("coral2", "lightblue"))+
   labs(x="Rate" , y = "log(Number of Positive Votes)")+
   theme_light()
grid.arrange(v1 , v2 , nrow=1)
```
Taking into account the number of positive votes again does not help identifying if a film is more probably getting a rate lower than 7 or higher than 7 . 

We might now check if there is any potential structure among our explanatory variables. 
First we want to check if different genres have different duraition. 

```{r corr ,  out.width='58%', fig.align="center",fig.cap = "\\label{fig:votes} Genre and Length", fig.pos = 'H' }
# Correlation between the explanatory variables 
ggplot(film , aes(x=genre , y=length )) + 
   geom_boxplot(fill="HotPink3")+
   labs(x="Genre" , y = "Length")+
      theme_light()

corr <- data.frame(lapply(film[,-c(1,6)], as.integer))
corr <- corr %>% 
   mutate_all(scale)
# Plot the graph
library(GGally)
ggcorr(corr,
    method = c("pairwise", "spearman"),
    nbreaks = 6,
    hjust = 0.8,
    label = TRUE,
    label_size = 3,
    color = "grey50")
``` 
We see that in general films' duration are roughly in same range except Documentary which has a wider range.
In summary we do not observe any correlation between any of our continuous explanatory variables as all have their absolute value of pairwise correlation coefficient lower than 0.4. 




# Formal Data Analysis {#sec:FDA}

As we noticed from our exploratory analysis the genres Romance,Drama,Animation and Short they all do not have significant explanation thus we remove observations related to those genres.
Also since we notices that length of the film might be a significant property that can determine the rating scale we proceed and remove observations that have missing values for length.
The model we are going to fit to our data is the following 

$$ \log(\frac{p}{1-p}) = \beta_0 + \beta_1 \mathbb{I}_{comedy}+\beta_2 \mathbb{I}_{documentary} + \beta_3 \cdot Length_i + \beta_4\cdot Budget_i+\epsilon_i, ~~~~ \epsilon_i \sim N(0, \sigma^2)$$

where 
\begin{itemize}
\item p is the probability a film getting a rate lower than 7.
\item $\mathbb{I}_{comedy}$ indicator factor that get value 1 if the $i^{th}$ film is comedy.
\item $\mathbb{I}_{Documentary}$ indicator factor that get value 1 if the $i^{th}$ film is documanetary.
\item $\beta_0 $ intercept term of the model
\item $\beta_3 , \beta_4 $ are coefficients for Length and Budget of $i^{th}$ film.
\end{itemize}

```{r model, echo =FALSE , include= FALSE}

# Data frame with Romance/Drama/Animation/Short genres removed 
film2 <- film[!(film$genre %in% c("Romance","Drama","Short","Animation")),]

# Remove missing values from length 
film2 <- na.omit(film2)

# We will apply model with genre , length and budget as we assumed those are 
# the mmost significant explanatories
 model <- glm( Rate ~ genre + length + budget  , data = film2 , 
               family = binomial(link = "logit"))

```

Now to assess model fit we compare it other model. First we compare it with the full model, which has all features as explanatory variables. 



```{r modelfull, out.width='58%', fig.align="center",fig.cap = "\\label{fig:fullmodelCI} 95\\% CI for Odds ratio", fig.pos = 'H' } 

# Apply full model using all available properties 
# We also log-transform the variable votes as it has wide variability 

model_full <- glm ( Rate ~ year + genre + length + log(votes) + budget , 
                    data= film2 , 
                    family = binomial(link = "logit"))

 # p1 <- plot_model(model_full , show.values = TRUE , show.p = FALSE ) + theme_light()
plot_model(model_full , show.values = TRUE , show.p = FALSE) + theme_light()



```
The odds ratio is estimated as follows 
$$\frac{\hat p}{1-\hat p} = \exp(x^T_i\cdot\hat{\beta})$$ 
$$= \exp( \hat\beta_0 + \hat\beta_1 \mathbb{I}_{comedy}+\hat\beta_2 \mathbb{I}_{documentary} + \hat\beta_3 \cdot Length_i + \hat\beta_4\cdot Budget_i)$$

Figure \ref{fig:fullmodelCI} shows that the coefficient for year has an estimate of`r exp(coefficients(model_full)["year"])` with 95\% confidence interval `r exp(confint(model_full)["year",])`, which contains 1 and that indicates that year is not a significant predictor for the odds ratio, thus we drop it from the model.
Next we apply a model with year removed. Using the deviance difference we compare it with our model. 


```{r model2 ,}
# model with year removed
model2 <- glm ( Rate ~ genre + length + log(votes) + budget, 
                    data= film2 , 
                    family = binomial(link = "logit"))

anova(model,model2) %>% 
   kable(caption = "\\label{tab:Dev} Defference of Deviance " , booktabs=T) %>% 
   kable_styling(latex_options = "HOLD_position" , font_size = 10)
dev_diff <- anova(model,model2)[2,"Deviance"]

```
Table \ref{tab:Dev} gives the difference in the deviance between the two models. We use Chi-squared asymptotic theorem to conduct the hypothesis test . 
Now ${\chi}^2(1;0.95)=$ `r round(qchisq(df=1 , p=0.95),digits=3)` and compared to the difference of deviance,
`r round(qchisq(df=1 , p=0.95),digits=3)` \textless `r round(dev_diff,digits=3)`, this indicates that there is no significant evidence to reject the null hypothesis, which states that our model is a better fit than model2.


## Interpretation of model's estimates 
```{r}
# add log-odds to the df 
film2$logOdds <- model$fitted.values
   film2$Odds <- exp(model$fitted.values)
film2$test <- predict(model)
                 

```


# Residuals 



# Conclusion and further task {#sec:Conclude}
